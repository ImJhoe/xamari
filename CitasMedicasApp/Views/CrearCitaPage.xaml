<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CitasMedicasApp.Views.CrearCitaPage"
             Title="Crear Nueva Cita">

    <ScrollView BackgroundColor="#f8f9fa">
        <StackLayout Padding="20" Spacing="15">

            <!-- Título -->
            <Label Text="CREAR NUEVA CITA MÉDICA" 
                   FontSize="22" 
                   FontAttributes="Bold"
                   HorizontalOptions="Center"
                   TextColor="#2c3e50"
                   Margin="0,10,0,20"/>

            <!-- PASO 1: Búsqueda del Paciente -->
            <Frame BackgroundColor="White" HasShadow="True" CornerRadius="10">
                <StackLayout Spacing="15">
                    <Label Text="PASO 1: BUSCAR PACIENTE" 
                           FontSize="16" 
                           FontAttributes="Bold" 
                           TextColor="#34495e"/>

                    <!-- Búsqueda por cédula -->
                    <StackLayout Orientation="Horizontal" Spacing="10">
                        <Entry x:Name="CedulaPacienteEntry" 
                               Placeholder="Ingrese cédula del paciente"
                               Keyboard="Numeric"
                               MaxLength="10"
                               HorizontalOptions="FillAndExpand"/>

                        <Button x:Name="BuscarPacienteButton" 
                                Text="🔍 BUSCAR" 
                                BackgroundColor="#3498db"
                                TextColor="White"
                                CornerRadius="20"
                                Clicked="OnBuscarPacienteClicked"/>
                    </StackLayout>

                    <!-- Resultado de la búsqueda -->
                    <StackLayout x:Name="ResultadoBusquedaStack" IsVisible="False">
                        <!-- Se llenará dinámicamente -->
                    </StackLayout>

                    <!-- Mensaje cuando no se encuentra paciente -->
                    <StackLayout x:Name="PacienteNoEncontradoStack" IsVisible="False" Spacing="10">
                        <Label Text="⚠️ Paciente no encontrado" 
                               TextColor="#e74c3c" 
                               FontAttributes="Bold"
                               HorizontalOptions="Center"/>

                        <Button x:Name="AñadirPacienteButton" 
                                Text="➕ AÑADIR PACIENTE" 
                                BackgroundColor="#27ae60"
                                TextColor="White"
                                CornerRadius="25"
                                Clicked="OnAñadirPacienteClicked"/>
                    </StackLayout>

                </StackLayout>
            </Frame>

            <!-- PASO 2: Datos de la Cita -->
            <Frame x:Name="DatosCitaFrame" 
                   BackgroundColor="White" 
                   HasShadow="True" 
                   CornerRadius="10"
                   IsVisible="False">
                <StackLayout Spacing="15">
                    <Label Text="PASO 2: DATOS DE LA CITA" 
                           FontSize="16" 
                           FontAttributes="Bold" 
                           TextColor="#34495e"/>

                    <!-- Especialidad -->
                    <StackLayout>
                        <Label Text="Especialidad:" FontAttributes="Bold" TextColor="#555"/>
                        <Picker x:Name="EspecialidadPicker" 
                                Title="Seleccione una especialidad"
                                ItemDisplayBinding="{Binding nombre_especialidad}"
                                SelectedIndexChanged="OnEspecialidadChanged"/>
                    </StackLayout>

                    <!-- Médico -->
                    <StackLayout>
                        <Label Text="Médico:" FontAttributes="Bold" TextColor="#555"/>
                        <Picker x:Name="MedicoPicker" 
                                Title="Primero seleccione una especialidad"
                                ItemDisplayBinding="{Binding nombre_completo}"
                                SelectedIndexChanged="OnMedicoChanged"/>
                    </StackLayout>

                    <!-- Sucursal -->
                    <StackLayout>
                        <Label Text="Sucursal:" FontAttributes="Bold" TextColor="#555"/>
                        <Picker x:Name="SucursalPicker" 
                                Title="Primero seleccione un médico"
                                ItemDisplayBinding="{Binding nombre_sucursal}"
                                SelectedIndexChanged="OnSucursalChanged"/>
                    </StackLayout>

                    <!-- Fecha de la cita -->
                    <StackLayout>
                        <Label Text="Fecha de la cita:" FontAttributes="Bold" TextColor="#555"/>
                        <DatePicker x:Name="FechaCitaDatePicker" 
                                  MinimumDate="{x:Static x:DateTime.Now}"
                                  DateSelected="OnFechaSelected"/>
                    </StackLayout>

                    <!-- Hora disponible -->
                    <StackLayout x:Name="HoraDisponibleStack" IsVisible="False">
                        <Label Text="Horarios disponibles:" FontAttributes="Bold" TextColor="#555"/>
                        <Picker x:Name="HoraPicker" 
                                Title="Seleccione una hora"/>

                        <!-- Indicador de carga para horarios -->
                        <ActivityIndicator x:Name="LoadingHorariosIndicator" 
                                         IsVisible="False"
                                         IsRunning="False"
                                         Color="#3498db"/>
                    </StackLayout>

                    <!-- Tipo de cita -->
                    <StackLayout>
                        <Label Text="Tipo de cita:" FontAttributes="Bold" TextColor="#555"/>
                        <Picker x:Name="TipoCitaPicker" 
                                Title="Seleccione tipo de cita"
                                ItemDisplayBinding="{Binding nombre_tipo}"
                                SelectedIndexChanged="OnTipoCitaChanged"/>
                    </StackLayout>

                    <!-- Enlace virtual (solo si es virtual) -->
                    <StackLayout x:Name="EnlaceVirtualStack" IsVisible="False">
                        <Label Text="Enlace virtual:" FontAttributes="Bold" TextColor="#555"/>
                        <Entry x:Name="EnlaceVirtualEntry" 
                               Placeholder="https://zoom.us/j/123456789"/>
                    </StackLayout>

                    <!-- Motivo -->
                    <StackLayout>
                        <Label Text="Motivo de la consulta:" FontAttributes="Bold" TextColor="#555"/>
                        <Editor x:Name="MotivoEditor" 
                                Placeholder="Describa brevemente el motivo de la cita..."
                                HeightRequest="80"/>
                    </StackLayout>

                    <!-- Notas adicionales -->
                    <StackLayout>
                        <Label Text="Notas adicionales (opcional):" FontAttributes="Bold" TextColor="#555"/>
                        <Editor x:Name="NotasEditor" 
                                Placeholder="Información adicional relevante..."
                                HeightRequest="60"/>
                    </StackLayout>

                </StackLayout>
            </Frame>

            <!-- Mensaje de estado -->
            <Label x:Name="MessageLabel" 
                   Text="" 
                   IsVisible="False"
                   HorizontalOptions="Center"
                   FontAttributes="Bold"
                   Margin="0,10"/>

            <!-- Botones de acción -->
            <StackLayout x:Name="BotonesAccionStack" 
                         IsVisible="False"
                         Orientation="Horizontal" 
                         HorizontalOptions="FillAndExpand" 
                         Spacing="10"
                         Margin="0,20,0,0">

                <Button x:Name="LimpiarFormButton" 
                        Text="LIMPIAR" 
                        BackgroundColor="#95a5a6"
                        TextColor="White"
                        CornerRadius="25"
                        HorizontalOptions="FillAndExpand"
                        Clicked="OnLimpiarFormClicked"/>

                <Button x:Name="CrearCitaButton" 
                        Text="CREAR CITA" 
                        BackgroundColor="#e74c3c"
                        TextColor="White"
                        CornerRadius="25"
                        HorizontalOptions="FillAndExpand"
                        Clicked="OnCrearCitaClicked"/>

            </StackLayout>

            <!-- Indicador de carga general -->
            <ActivityIndicator x:Name="LoadingIndicator" 
                             IsVisible="False"
                             IsRunning="False"
                             Color="#e74c3c"
                             HeightRequest="50"/>

        </StackLayout>
    </ScrollView>
</ContentPage>