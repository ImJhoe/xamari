<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CitasMedicasApp.Views.CrearCitaPage"
             Title="Crear Cita">

    <ContentPage.Content>
        <ScrollView Padding="20" BackgroundColor="#f8f9fa">
            <StackLayout Spacing="20">

                <!-- Título dinámico -->
                <Frame x:Name="TituloFrame" BackgroundColor="#e67e22" HasShadow="True" CornerRadius="10">
                    <StackLayout Orientation="Horizontal" Spacing="10">
                        <Label x:Name="TituloIcon" Text="📅" FontSize="24"/>
                        <StackLayout VerticalOptions="Center">
                            <Label x:Name="TituloLabel"
                                   Text="CREAR NUEVA CITA" 
                                   TextColor="White" 
                                   FontSize="16" 
                                   FontAttributes="Bold"/>
                            <Label x:Name="SubtituloLabel"
                                   Text="Punto 3 de la lista de cotejo" 
                                   TextColor="#ecf0f1" 
                                   FontSize="12"/>
                        </StackLayout>
                    </StackLayout>
                </Frame>

                <!-- PUNTO 3 y 4: Búsqueda de paciente por cédula -->
                <Frame BackgroundColor="White" HasShadow="True" CornerRadius="10">
                    <StackLayout Spacing="15">
                        <Label Text="🔍 PUNTO 3-4: BUSCAR PACIENTE POR CÉDULA" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="#e67e22"/>
                        <Label Text="Opción de búsqueda por cédula del paciente" 
                               FontSize="12" 
                               TextColor="#7f8c8d"/>

                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Entry x:Name="CedulaEntry" 
                                   Placeholder="Ingrese cédula del paciente"
                                   Keyboard="Numeric"
                                   MaxLength="10"
                                   HorizontalOptions="FillAndExpand"/>

                            <Button x:Name="BuscarPacienteButton"
                                    Text="🔍"
                                    BackgroundColor="#3498db"
                                    TextColor="White"
                                    CornerRadius="20"
                                    WidthRequest="50"
                                    Clicked="OnBuscarPacienteClicked"/>
                        </StackLayout>
                    </StackLayout>
                </Frame>

                <!-- RESULTADO DE BÚSQUEDA DE PACIENTE -->
                <StackLayout x:Name="ResultadoPacienteStack" IsVisible="False" Spacing="10">

                    <!-- Paciente encontrado -->
                    <Frame x:Name="PacienteEncontradoFrame" 
                           BackgroundColor="White" 
                           HasShadow="True" 
                           CornerRadius="10"
                           IsVisible="False">
                        <StackLayout Spacing="10">
                            <Label Text="✅ PACIENTE ENCONTRADO" 
                                   FontAttributes="Bold" 
                                   FontSize="16"
                                   TextColor="#27ae60"/>

                            <StackLayout x:Name="DatosPacienteStack"/>

                            <Button Text="📅 CONTINUAR CON LA CITA"
                                    BackgroundColor="#27ae60"
                                    TextColor="White"
                                    CornerRadius="25"
                                    Clicked="OnContinuarConCitaClicked"/>
                        </StackLayout>
                    </Frame>

                    <!-- Paciente NO encontrado - PUNTO 4B -->
                    <Frame x:Name="PacienteNoEncontradoFrame" 
                           BackgroundColor="White" 
                           HasShadow="True" 
                           CornerRadius="10"
                           IsVisible="False">
                        <StackLayout Spacing="15">
                            <Label Text="❌ PACIENTE NO ENCONTRADO" 
                                   FontAttributes="Bold" 
                                   FontSize="16"
                                   TextColor="#e74c3c"/>

                            <Label Text="No existe un paciente registrado con esa cédula." 
                                   FontSize="14" 
                                   TextColor="#7f8c8d"/>

                            <!-- PUNTO 4B: Botón "Añadir paciente" -->
                            <Button x:Name="AnadirPacienteButton"
                                    Text="➕ AÑADIR PACIENTE"
                                    BackgroundColor="#e67e22"
                                    TextColor="White"
                                    CornerRadius="25"
                                    Clicked="OnAnadirPacienteClicked"/>
                        </StackLayout>
                    </Frame>

                </StackLayout>

                <!-- FORMULARIO DE CITA - Solo visible después de seleccionar paciente -->
                <Frame x:Name="FormularioCitaFrame" 
                       BackgroundColor="White" 
                       HasShadow="True" 
                       CornerRadius="10"
                       IsVisible="False">
                    <StackLayout Spacing="15">
                        <Label Text="📋 DETALLES DE LA CITA" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="#3498db"/>

                        <!-- Especialidad -->
                        <StackLayout>
                            <Label Text="🏥 Especialidad:" FontAttributes="Bold" TextColor="#555"/>
                            <Picker x:Name="EspecialidadPicker" 
                                    Title="Seleccione especialidad"
                                    SelectedIndexChanged="OnEspecialidadChanged"/>
                        </StackLayout>

                        <!-- Médico -->
                        <StackLayout>
                            <Label Text="👨‍⚕️ Médico:" FontAttributes="Bold" TextColor="#555"/>
                            <Picker x:Name="MedicoPicker" 
                                    Title="Primero seleccione especialidad"
                                    SelectedIndexChanged="OnMedicoChanged"/>
                        </StackLayout>

                        <!-- Sucursal -->
                        <StackLayout>
                            <Label Text="🏢 Sucursal:" FontAttributes="Bold" TextColor="#555"/>
                            <Picker x:Name="SucursalPicker" 
                                    Title="Primero seleccione médico"
                                    SelectedIndexChanged="OnSucursalChanged"/>
                        </StackLayout>

                        <!-- Fecha de la cita -->
                        <StackLayout>
                            <Label Text="📅 Fecha de la cita:" FontAttributes="Bold" TextColor="#555"/>
                            <DatePicker x:Name="FechaCitaPicker" 
                                       DateSelected="OnFechaChanged"/>
                        </StackLayout>

                        <!-- PUNTO 7: Horarios disponibles del médico -->
                        <StackLayout x:Name="HorariosDisponiblesStack" IsVisible="False" Spacing="10">
                            <Label Text="🕒 PUNTO 7: HORARIOS DISPONIBLES" 
                                   FontAttributes="Bold" 
                                   TextColor="#1abc9c"/>
                            <Label Text="La app muestra horarios disponibles del médico para seleccionar" 
                                   FontSize="12" 
                                   TextColor="#7f8c8d"/>

                            <CollectionView x:Name="HorariosCollectionView" HeightRequest="200">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="5">
                                            <Frame BackgroundColor="{Binding ColorFondo}" 
                                                   CornerRadius="8" 
                                                   Padding="10"
                                                   HasShadow="False">
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <StackLayout Grid.Column="0">
                                                        <Label Text="{Binding HorarioTexto}" 
                                                               FontAttributes="Bold"/>
                                                        <Label Text="{Binding EstadoTexto}" 
                                                               FontSize="12"/>
                                                    </StackLayout>
                                                    <RadioButton Grid.Column="1" 
                                                               IsChecked="{Binding EstaSeleccionado}"
                                                               IsEnabled="{Binding EstaDisponible}"
                                                               CheckedChanged="OnHorarioSeleccionado"/>
                                                </Grid>
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </StackLayout>

                        <!-- Motivo -->
                        <StackLayout>
                            <Label Text="📝 Motivo de la consulta:" FontAttributes="Bold" TextColor="#555"/>
                            <Editor x:Name="MotivoEditor" 
                                   Placeholder="Describa brevemente el motivo de la consulta"
                                   HeightRequest="80"/>
                        </StackLayout>

                        <!-- Tipo de cita -->
                        <StackLayout>
                            <Label Text="💻 Tipo de cita:" FontAttributes="Bold" TextColor="#555"/>
                            <Picker x:Name="TipoCitaPicker"/>
                        </StackLayout>
                    </StackLayout>
                </Frame>

                <!-- RESUMEN DE LA CITA -->
                <Frame x:Name="ResumenCitaFrame" 
                       BackgroundColor="White" 
                       HasShadow="True" 
                       CornerRadius="10"
                       IsVisible="False">
                    <StackLayout Spacing="10">
                        <Label Text="📋 RESUMEN DE LA CITA" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="#9b59b6"/>

                        <StackLayout x:Name="ResumenDetallesStack"/>

                        <Button x:Name="ConfirmarCitaButton"
                                Text="✅ CONFIRMAR Y CREAR CITA"
                                BackgroundColor="#27ae60"
                                TextColor="White"
                                CornerRadius="25"
                                FontAttributes="Bold"
                                Clicked="OnConfirmarCitaClicked"/>
                    </StackLayout>
                </Frame>

                <!-- Botones de navegación -->
                <StackLayout Spacing="10">
                    <Button x:Name="ActualizarResumenButton"
                            Text="🔄 ACTUALIZAR RESUMEN"
                            BackgroundColor="#3498db"
                            TextColor="White"
                            CornerRadius="25"
                            IsVisible="False"
                            Clicked="OnActualizarResumenClicked"/>

                    <Button Text="❌ CANCELAR"
                            BackgroundColor="#95a5a6"
                            TextColor="White"
                            CornerRadius="25"
                            Clicked="OnCancelarClicked"/>
                </StackLayout>

                <!-- Loading indicator -->
                <ActivityIndicator x:Name="LoadingIndicator" 
                                 IsVisible="False" 
                                 IsRunning="False" 
                                 Color="#e67e22"/>

            </StackLayout>
        </ScrollView>
    </ContentPage.Content>
</ContentPage>